image: docker:stable-git
#stages: ["build", "test", "deploy"]
# TODO: create separate stages
deploy:
  stage: deploy
  only:
    - develop
  services:
    - docker:19.03.12-dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:latest # $CI_COMMIT_REF_SLUG
    DOCKER_DRIVER: overlay
    KUBE_CONFIG: YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VONVJFTkRRV0pEWjBGM1NVSkJaMGxDUVVSQlRrSm5hM0ZvYTJsSE9YY3dRa0ZSYzBaQlJFRldUVkpOZDBWUldVUldVVkZFUlhkd2NtUlhTbXdLWTIwMWJHUkhWbnBOUWpSWVJGUkpkMDFVU1hkTmFrRXhUWHByZVU1c2IxaEVWRTEzVFZSRmVrMUVRVEZOZW10NVRteHZkMFpVUlZSTlFrVkhRVEZWUlFwQmVFMUxZVE5XYVZwWVNuVmFXRkpzWTNwRFEwRlRTWGRFVVZsS1MyOWFTV2gyWTA1QlVVVkNRbEZCUkdkblJWQkJSRU5EUVZGdlEyZG5SVUpCVGtvMkNuZE1MMU5IVDB0a2VuWlhiMmg0VGxkV1dtaHphREpvWm5ndk9GRldiVGRrWTBJelkxbFJjaTlTVWpSb05FVTVVemRsT1RCbFZVcG1XbFJzVnpsUE5FMEtiVkZTVmtoUWNUWmxiREJOTUdVdlEzSlJiR0oyTUdWdE1tWmhVbk51VERGRFdqbGFVelZxUTFjdmNISlliM3B0TjNGNFpXRm9PVTF1YmpRdlIxcHlPQXB0VmpWRFJrd3JkWEIzV0dkU1pVbHVaalkySzFnd2JqVm9hR0Z0Y1U5amREaEJRV05tT1hwM2EyVlViVkpQUTFsNVJWTjBOSEEwVURaVE15dFpMM2haQ21RdlIzbFdlbkZ4S3pSeUwySmlVbTFTVEhOWVVqbFdXRnBLZUd0VmJtVjBURWxNWkVWMFRYVmlhR3RKUW1wdVZEZFJhMkZ5UmtSWldHdElSVlIzYlZZS2JTdFVSVkZuVFdSdWNUbFllRTFzY2xjeVduQlhXVGxRZEN0MmREZGxjRFJXTDJaaGVFMTVUekEwV0VsVWQxZFRVR0kzTTNSclExUmtURGd5ZEdwR2JncGhhemRDYVdKblVIZGhVMVZtVUc0M1kydE5RMEYzUlVGQllVMXFUVU5GZDBSbldVUldVakJRUVZGSUwwSkJVVVJCWjB0clRVRTRSMEV4VldSRmQwVkNDaTkzVVVaTlFVMUNRV1k0ZDBSUldVcExiMXBKYUhaalRrRlJSVXhDVVVGRVoyZEZRa0ZMVmpoc1duVkhPR1ZNVEhkalVFdHlORXN2U1VGaGNsaHFXRFFLZW1weGJUTk9iVzVNYkdGaFduSjFWazE0VkdoS2VrTjBNVFl4U1RaRlIxTjVVMGN5ZGpsQ1JTOHpSbkZGWVZwNk1IZ3pZbXBKZFUxSlVHYzFkWEo0V2dwa1ZYcERWMUJ4ZFZkbVZYRklLMWhGTkdnMGVEaDZTa3huU25CNVJpdHViMkZ4YzI1cWN6Rk9jakYzYjJWWFdVNUtTa1JRWTA5WlduQlVWV3RzVlRFekNuTTRkbFI0Um14cFJUVm9aSFZZVlRGMGJ6RnFNSFZMY2twdk1tWlVPVmRJU2psblJ6VmFSbEEzTDFOVGIySlFUbUV6YnpCMWEzVXpZVk5vV21Jd1NXc0tUa0ZoY0UxUlQwSlZMM05PY1V0MGR5OVpjaTlMV0ROTFVHRjFTMmRJSzJaTVRFTlBjRnBsTlhZM1dXTTNkVzFtYkM5dE5HZEthRXRTVVdVd2IzazNWUW8zV2xwa0x6SXJjemhoVVVzNWQycEdUVzlwTlRsUFdVdEtXRU5yVG5wQmFHRjVVakk0ZURsUU5tWlZNM2RZWWpkQ1RVWXZaaXRtYWxoemF6MEtMUzB0TFMxRlRrUWdRMFZTVkVsR1NVTkJWRVV0TFMwdExRbz0KICAgIHNlcnZlcjogaHR0cHM6Ly84ZmIwMjI1Yi0yYjgxLTQ2NDItYjJhNi1mMDBjN2ExZTM3NmQuY3BjMS11cy1jZW50cmFsLmxpbm9kZWxrZS5uZXQ6NDQzCiAgbmFtZTogbGtlMTQzNzAKY29udGV4dHM6Ci0gY29udGV4dDoKICAgIGNsdXN0ZXI6IGxrZTE0MzcwCiAgICBuYW1lc3BhY2U6IGRlZmF1bHQKICAgIHVzZXI6IGxrZTE0MzcwLWFkbWluCiAgbmFtZTogbGtlMTQzNzAtY3R4CmN1cnJlbnQtY29udGV4dDogbGtlMTQzNzAtY3R4CmtpbmQ6IENvbmZpZwpwcmVmZXJlbmNlczoge30KdXNlcnM6Ci0gbmFtZTogbGtlMTQzNzAtYWRtaW4KICB1c2VyOgogICAgdG9rZW46IGV5SmhiR2NpT2lKU1V6STFOaUlzSW10cFpDSTZJakJGTlVWM01GZDZhM3AzZGt4TGNqZE1ZVk5uU1hacVkzSXdUVVI2Y0cxNU1VRjNWR2swTFhWQk0xa2lmUS5leUpwYzNNaU9pSnJkV0psY201bGRHVnpMM05sY25acFkyVmhZMk52ZFc1MElpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl1WVcxbGMzQmhZMlVpT2lKcmRXSmxMWE41YzNSbGJTSXNJbXQxWW1WeWJtVjBaWE11YVc4dmMyVnlkbWxqWldGalkyOTFiblF2YzJWamNtVjBMbTVoYldVaU9pSnNhMlV0WVdSdGFXNHRkRzlyWlc0dGJXNXliRFFpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pYkd0bExXRmtiV2x1SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaWEoyYVdObExXRmpZMjkxYm5RdWRXbGtJam9pWXpneFpUWTVNRFV0T0RSa01TMDBNV0ZtTFRnNFpHTXROVEppTURrd1pUUm1NR1F5SWl3aWMzVmlJam9pYzNsemRHVnRPbk5sY25acFkyVmhZMk52ZFc1ME9tdDFZbVV0YzNsemRHVnRPbXhyWlMxaFpHMXBiaUo5LlZicHplMnF4UkVQelBtU1dmTUpLLXl0MklyV29acjdSTjJpRDFocS1DVjVCQnNPNGpYc1hrSnVLUjNXRHV5Nmx4SzhEemZrNm05NkpxbEV2cFgwdkFVczc2bDVDZWw0czNmMW56SXJRZTZVck00MTN2elZqRmdsaFNqUEFoVWZnOTBMeXZoTFpNS0hLQ01ES2VtbjZuOS1WWXBiUWsxNlYxN0Nfd25uQjBUajBtVHN5VmtHU0ZqYi1ERUplSEdMZEJrMmRsc3l2ampZUDBRaW5zWmcxeUxlZjlialVtRDVINVlmWHlQYUdwNFhqZXF3dXFXSmFHZkZReXVMelI2NktlQ01TTmRDekdLVGJHTWllMkJlNENrZHFJNFVBQTNjeXZlV09NWFIzMER1VVR3WTNNM3Q3QjVTZXQzM2pYWUp4YlhjUnB4MmR6b2dpLUV3blFlcG8xQQo=
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
    - apk update  && apk add --no-cache curl
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
    - mkdir -p $HOME/.kube
    - echo -n $KUBE_CONFIG | base64 -d > $HOME/.kube/config
    - apk add --update coreutils
    - export $KUBE_CONFIG | base64 --decode
    - kubectl delete pods --selector=app=animated-offers-app
